<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="PersonalFinanceTracker.Views.AnalyticsPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:PersonalFinanceTracker.ViewModels"
             xmlns:models="clr-namespace:PersonalFinanceTracker.Models"
             x:DataType="viewmodels:AnalyticsViewModel"
             Title="Analytics"
             Shell.TabBarIsVisible="True">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Refresh" 
                     Command="{Binding LoadCommand}"
                     IconImageSource="refresh.png" />
    </ContentPage.ToolbarItems>

    <Grid>
        <!-- Loading Indicator -->
        <ActivityIndicator IsVisible="{Binding IsBusy}"
                           IsRunning="{Binding IsBusy}"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           Color="{StaticResource Primary}" />

        <ScrollView IsVisible="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}">
            <StackLayout Padding="16" Spacing="20">

                <!-- Financial Overview -->
                <Label Text="Financial Overview" 
                       FontSize="24" 
                       FontAttributes="Bold"
                       TextColor="{StaticResource Primary}" />

                <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="12" RowSpacing="12">
                    <!-- Income -->
                    <Frame Grid.Row="0" Grid.Column="0"
                           BackgroundColor="{StaticResource Secondary}"
                           Padding="16"
                           CornerRadius="12"
                           HasShadow="True">
                        <StackLayout>
                            <Label Text="Income" 
                                   FontSize="14" 
                                   TextColor="{StaticResource OnSecondary}" />
                            <Label Text="{Binding TotalIncomeText}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource OnSecondary}" />
                        </StackLayout>
                    </Frame>

                    <!-- Expenses -->
                    <Frame Grid.Row="0" Grid.Column="1"
                           BackgroundColor="{StaticResource Error}"
                           Padding="16"
                           CornerRadius="12"
                           HasShadow="True">
                        <StackLayout>
                            <Label Text="Expenses" 
                                   FontSize="14" 
                                   TextColor="{StaticResource OnError}" />
                            <Label Text="{Binding TotalSpentText}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource OnError}" />
                        </StackLayout>
                    </Frame>

                    <!-- Net Amount -->
                    <Frame Grid.Row="1" Grid.Column="0"
                           BackgroundColor="{Binding NetAmountColor}"
                           Padding="16"
                           CornerRadius="12"
                           HasShadow="True">
                        <StackLayout>
                            <Label Text="Net Balance"
                                   FontSize="14"
                                   TextColor="White" />
                            <Label Text="{Binding NetAmountText}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="White" />
                        </StackLayout>
                    </Frame>

                    <!-- Daily Average -->
                    <Frame Grid.Row="1" Grid.Column="1"
                           BackgroundColor="{StaticResource Tertiary}"
                           Padding="16"
                           CornerRadius="12"
                           HasShadow="True">
                        <StackLayout>
                            <Label Text="Daily Avg Spend"
                                   FontSize="14"
                                   TextColor="{StaticResource OnTertiary}" />
                            <Label Text="{Binding DailyAverageText}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource OnTertiary}" />
                        </StackLayout>
                    </Frame>
                </Grid>

                <!-- Spending by Category -->
                <Frame BackgroundColor="{StaticResource Surface}"
                       Padding="16"
                       CornerRadius="12"
                       HasShadow="True">
                    <StackLayout>
                        <Label Text="Spending by Category"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="{StaticResource OnSurface}"
                               Margin="0,0,0,16" />

                        <CollectionView ItemsSource="{Binding CategorySpending}"
                                        HeightRequest="200">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:CategorySpending">
                                    <Grid ColumnDefinitions="Auto,*,Auto"
                                          Padding="0,8"
                                          ColumnSpacing="12">
                                        <Ellipse WidthRequest="12"
                                                 HeightRequest="12"
                                                 Fill="{Binding Color}" />

                                        <StackLayout Grid.Column="1">
                                            <Label Text="{Binding CategoryName}"
                                                   FontSize="14"
                                                   FontAttributes="Bold" />
                                            <ProgressBar Progress="{Binding Percentage}"
                                                         ProgressColor="{Binding Color}"
                                                         HeightRequest="4" />
                                        </StackLayout>

                                        <StackLayout Grid.Column="2" HorizontalOptions="End">
                                            <Label Text="{Binding Amount, StringFormat='{0:C}'}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   HorizontalTextAlignment="End" />
                                            <Label Text="{Binding Percentage, StringFormat='{0:P1}'}"
                                                   FontSize="12"
                                                   TextColor="{StaticResource OnSurfaceVariant}"
                                                   HorizontalTextAlignment="End" />
                                        </StackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>
                </Frame>

                <!-- Monthly Trends -->
                <Frame BackgroundColor="{StaticResource Surface}"
                       Padding="16"
                       CornerRadius="12"
                       HasShadow="True">
                    <StackLayout>
                        <Label Text="Monthly Trends"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="{StaticResource OnSurface}"
                               Margin="0,0,0,16" />

                        <CollectionView ItemsSource="{Binding MonthlyTrends}"
                                        HeightRequest="150">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Horizontal" ItemSpacing="16" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:MonthlyTrend">
                                    <StackLayout WidthRequest="80" HorizontalOptions="Center">
                                        <Grid HeightRequest="80" VerticalOptions="End">
                                            <Rectangle Fill="{StaticResource Primary}" Opacity="0.3" HeightRequest="80" />
                                            <Rectangle Fill="{StaticResource Primary}"
                                                       HeightRequest="{Binding Income, Converter={StaticResource AmountToHeightConverter}}"
                                                       VerticalOptions="End" />
                                            <Rectangle Fill="{StaticResource Error}"
                                                       HeightRequest="{Binding Expenses, Converter={StaticResource AmountToHeightConverter}}"
                                                       VerticalOptions="End"
                                                       Opacity="0.8" />
                                        </Grid>
                                        <Label Text="{Binding Month, StringFormat='{0:MMM}'}"
                                               FontSize="12"
                                               HorizontalTextAlignment="Center"
                                               Margin="0,8,0,0" />
                                        <Label Text="{Binding NetAmount, StringFormat='{0:C}'}"
                                               FontSize="10"
                                               HorizontalTextAlignment="Center"
                                               TextColor="{Binding NetAmount, Converter={StaticResource BalanceToColorConverter}}" />
                                    </StackLayout>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>
                </Frame>

                <!-- Goal Progress -->
                <Frame BackgroundColor="{StaticResource Surface}"
                       Padding="16"
                       CornerRadius="12"
                       HasShadow="True"
                       IsVisible="{Binding GoalProgress.Count, Converter={StaticResource GreaterThanZeroConverter}}">
                    <StackLayout>
                        <Label Text="Goal Progress"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="{StaticResource OnSurface}"
                               Margin="0,0,0,16" />

                        <CollectionView ItemsSource="{Binding GoalProgress}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:FinancialGoalProgress">
                                    <Frame BackgroundColor="{StaticResource SurfaceVariant}"
                                           Padding="12"
                                           CornerRadius="8"
                                           Margin="0,4">
                                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto">
                                            <Label Grid.Row="0" Grid.Column="0"
                                                   Text="{Binding GoalName}"
                                                   FontSize="16"
                                                   FontAttributes="Bold" />
                                            <Label Grid.Row="0" Grid.Column="1"
                                                   Text="{Binding Status}"
                                                   FontSize="14"
                                                   TextColor="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                                   HorizontalOptions="End" />
                                            <ProgressBar Grid.Row="1" Grid.ColumnSpan="2"
                                                         Progress="{Binding ProgressPercentage}"
                                                         ProgressColor="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                                         Margin="0,8" />
                                            <Label Grid.Row="2" Grid.Column="0"
                                                   Text="{Binding CurrentAmount, StringFormat='Current: {0:C}'}"
                                                   FontSize="12"
                                                   TextColor="{StaticResource OnSurfaceVariant}" />
                                            <Label Grid.Row="2" Grid.Column="1"
                                                   Text="{Binding TargetAmount, StringFormat='Target: {0:C}'}"
                                                   FontSize="12"
                                                   TextColor="{StaticResource OnSurfaceVariant}"
                                                   HorizontalOptions="End" />
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>
                </Frame>

            </StackLayout>
        </ScrollView>
    </Grid>
</ContentPage>
